<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>예치금 충전</title>
    <script src="https://js.tosspayments.com/v2/standard"></script>
</head>
<body>
<div style="padding: 40px;">
    <h2>예치금 충전하기</h2>

    <div id="payment-method"></div>
    <div id="agreement"></div>

    <button class="button" id="payment-button" style="margin-top: 30px">
        충전하기
    </button>
</div>

<script th:inline="javascript">
    main();

    async function main() {
        // 1. Controller에서 넘겨준 memberId 받기 (필수)
        const memberId = [[${memberId}]];

        // 2. 충전할 금액 (예시: 10,000원) - 실제로는 input 값을 가져오세요.
        const chargeAmount = 10000;

        const button = document.getElementById("payment-button");

        // 3. 토스 결제 위젯 초기화
        const clientKey = "test_gck_docs_Ovk5rk1EwkEbP0W43n07xlzm"; // [주의] 본인 키로 변경
        const tossPayments = TossPayments(clientKey);

        // 회원 식별을 위한 CustomerKey 설정 (memberId 활용)
        const widgets = tossPayments.widgets({
            customerKey: "MEMBER_" + memberId,
        });

        // 금액 설정
        await widgets.setAmount({
            currency: "KRW",
            value: chargeAmount,
        });

        await widgets.renderPaymentMethods({ selector: "#payment-method", variantKey: "DEFAULT" });
        await widgets.renderAgreement({ selector: "#agreement", variantKey: "AGREEMENT" });

        button.addEventListener("click", async function () {

            // [중요] 주문 테이블이 없으므로 여기서 UUID(orderId)를 직접 생성
            const orderId = crypto.randomUUID();

            await widgets.requestPayment({
                orderId: orderId,
                orderName: "예치금 충전",
                // [핵심] successUrl 뒤에 memberId를 붙여서 넘겨줘야 success.html에서 API를 호출할 수 있음
                successUrl: window.location.origin + "/view/payments/success?memberId=" + memberId,
                failUrl: window.location.origin + "/view/payments/fail",
            });
        });
    }
</script>
</body>
</html>