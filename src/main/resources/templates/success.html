<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>충전 처리 중</title>
</head>
<body>
<h2>결제 승인 요청 중입니다...</h2>
<p>잠시만 기다려주세요.</p>

<script>
    process();

    async function process() {
        // 1. URL 파라미터 파싱
        const searchParams = new URLSearchParams(window.location.search);

        const paymentKey = searchParams.get('paymentKey'); // 토스가 줌
        const orderId = searchParams.get('orderId');       // 토스가 줌
        const amount = searchParams.get('amount');         // 토스가 줌
        const memberId = searchParams.get('memberId');     // checkout.html에서 우리가 붙인 값

        // 2. 유효성 검사 (memberId가 없으면 오류)
        if (!memberId) {
            alert("회원 정보를 찾을 수 없습니다.");
            return;
        }

        // 3. 백엔드 API 호출 (Controller 경로에 맞게 수정됨)
        // POST /api/v1/deposit/{memberId}
        const apiUrl = `/api/v1/deposit/${memberId}`;

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                // Controller의 @RequestBody PaymentConfirmRequest 구조와 일치해야 함
                body: JSON.stringify({
                    paymentKey: paymentKey,
                    orderId: orderId,
                    amount: Number(amount)
                })
            });

            const data = await response.json();

            if (response.ok) {
                // 성공 처리
                alert("충전 성공! 현재 잔액: " + data.currentBalance); // DepositResponse 필드명 확인 필요
                console.log("Response:", data);
                // location.href = "/mypage"; // 성공 후 이동할 페이지
            } else {
                // 실패 처리
                alert("충전 실패: " + (data.message || "알 수 없는 오류"));
                console.error("Error Response:", data);
            }

        } catch (error) {
            console.error('Network Error:', error);
            alert("서버 통신 중 오류가 발생했습니다.");
        }
    }
</script>
</body>
</html>